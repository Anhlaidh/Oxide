<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>ElasticSearch | Oxide</title>
<meta name="keywords" content="DB" />
<meta name="description" content="DB">
<meta name="author" content="Anhlaidh">
<link rel="canonical" href="http://blog.oxide.ink/posts/db/elasticsearch/" />
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.a7912db0dae3e62d0906024f5a11712a8f2023b34fe824cbb253e4731ec0117f.css" integrity="sha256-p5EtsNrj5i0JBgJPWhFxKo8gI7NP6CTLslPkcx7AEX8=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js" integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5&#43;kdJvBz5iKbt6B5PJI="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="http://blog.oxide.ink/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://blog.oxide.ink/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://blog.oxide.ink/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://blog.oxide.ink/apple-touch-icon.png">
<link rel="mask-icon" href="http://blog.oxide.ink/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<meta name="generator" content="Hugo 0.83.1" />
<link rel="alternate" hreflang="zh" href="http://blog.oxide.ink/posts/db/elasticsearch/" />

<script>
    document.addEventListener("DOMContentLoaded", function() {
      renderMathInElement(document.body, {
              delimiters: [
                  {left: "$$", right: "$$", display: true},
                  {left: "$", right: "$", display: false}
              ]
          });
    });
</script>



<script src="https://cdn.bootcss.com/mermaid/8.0.0-rc.8/mermaid.min.js"></script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0-rc.1/katex.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0-rc.1/katex.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0-rc.1/contrib/auto-render.min.js"></script>



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css">
<script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

<script>
    window.onload = function (){
        console.log("aaa");
    }
    const height = 300;
    makeCollapsible();
    function makeCollapsible() {
        const divs = document.querySelectorAll('.highlight');
        divs.forEach((e) => {
            if (e.offsetHeight > height) {
                e.style.maxHeight = height + 'px';
                e.style.overflow = 'hidden';
                const linkWrapper = document.createElement('div');
                const link = document.createElement('a');
                link.href = '';
                link.textContent = 'more';
                link.addEventListener('click', codeToggle);
                linkWrapper.className = 'highlight-link';
                linkWrapper.appendChild(link);
                e.appendChild(linkWrapper);
            }
        });
    }
    function codeToggle(e) {
        e.preventDefault();
        const link = e.target;
        const linkWrapper = link.parentElement.parentElement;
        if (link.innerHTML === 'more') {
            link.innerHTML = 'less';
            linkWrapper.style.maxHeight = '';
            linkWrapper.style.overflow = 'none';
            link.parentElement.style.right = '0';
        } else {
            link.innerHTML = 'more';
            linkWrapper.style.maxHeight = height + 'px';
            linkWrapper.style.overflow = 'hidden';
            link.parentElement.style.right = '0.5em';
            scrollToTargetAdjusted(linkWrapper);
        }
    }
    function scrollToTargetAdjusted(e) {
        const header = document.querySelector('header');
        const headerHeight = window.getComputedStyle(header, null).getPropertyValue('height');
        const headerOffset = Number(headerHeight.replace('px', ''));
        const bodyRect = document.body.getBoundingClientRect().top;
        const elementRect = e.getBoundingClientRect().top;
        const elementPosition = elementRect - bodyRect;
        const offsetPosition = elementPosition - headerOffset;
        window.scrollTo({
            top: offsetPosition,
            behavior: 'smooth'
        });
    }

</script><meta property="og:title" content="ElasticSearch" />
<meta property="og:description" content="DB" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://blog.oxide.ink/posts/db/elasticsearch/" />
<meta property="og:image" content="http://blog.oxide.ink/%3Cimage%20path/url%3E" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-07-01T20:58:36&#43;00:00" />
<meta property="article:modified_time" content="2021-07-01T20:58:36&#43;00:00" /><meta property="og:site_name" content="Oxide" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="http://blog.oxide.ink/%3Cimage%20path/url%3E" />
<meta name="twitter:title" content="ElasticSearch"/>
<meta name="twitter:description" content="DB"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "http://blog.oxide.ink/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "ElasticSearch",
      "item": "http://blog.oxide.ink/posts/db/elasticsearch/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "ElasticSearch",
  "name": "ElasticSearch",
  "description": "DB",
  "keywords": [
    "DB"
  ],
  "articleBody": "概述  ES不等于搜索引擎 分布式的搜索,存储,数据分析引擎 优点:  面向开发者友好,屏蔽了Luncene的复杂特性,集群自动发现 自动维护数据在多个节点上的建立 帮我们做搜索请求的负载均衡 自动维护冗余副本,保证了部分节点宕机的情况下仍然不会有任何数据丢失 ES基于Lucene提供了很多高级功能:符合查询,聚合分析,基于地理位置 对于大公司,可以构建几百台服务器的大型分布式集群,处理PB级别数据 相遇传统数据库,提供了全文见检索,同义词处理,相关度排名,聚合分析以及海量数据的近实时(NTR)处理,这些传统数据库完全做不到   应用领域  搜索引擎 各大网站的用户行为日志(点击,浏览,收藏,评论) BI 数据分析 Github ELK (Elasticseach(数据存储) Logstash(日志采集) Kibana(可视化))    核心概念和原理  搜索  SQL 用了%不能用索引 -性能差  like % 搜索时间复杂度O(n)   不能分词   倒排索引  分词 生成相关度 * 排序 空间换时间   数据结构  document List 关键词在每个doc中出现的次数 TF term frequency 词频 IDF inverse doc frequency 关键词在当前doc出现的次数 每个doc的长度 越长相关度越低 包含这个关键词的所有doc的平均长度     核心概念  集群:每个集群至少包含两个节点 Node:集群中的节点 一个节点不代表是一台机器 Filed: 一个数据字段,与index和type可以定位一个doc Document:ES最小的数据单元 Json Type:逻辑上的数据分类 Index:一类相同或者相似的doc 分片shard  一个index包含多个shard,默认5p,默认每个p分配一个r,p的数量在创建索引的时候设置,如果想修改,需要重建索引 每个shard都是一个lucene实例,有完整的创建索引的处理请求能力 ES会自动在nodes尚未我们zuoshard均衡 一个doc不可能同时存在于多个PShard,但是可以同时多个Rshard p和对应的r不能同时存在于同一个节点,所以最低的可用配置是两台节点,互为主备   横向扩容 Parimary Shared Replica Shard     容错  两台机子p0,p1,p2 r0,r1,r2 p挂掉之后r顶上 容错机制  master选举  findMaster  脑裂 可能会产生多个master节点   判断自己是否为master 广播/findMaster   replica容错 重启故障机 数据恢复  只拷贝新增数据 不是全量拷贝        使用  健康值检查  CRUD  Query String search 类似于Url挂参数搜索 Query DSL Query and filter  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52  GET /_cat/health?v PUT /test_index?pretty GET _cat/indices DELETE /test_index?pretty PUT /product/_doc/1 { \"name\":\"xiaomi erji\", \"desc\":\"erji zhong de huangmenji\", \"price\":1999, \"tags\":[\"low\",\"bufangshui\",\"yinzhicha\"] } PUT /product/_doc/2 { \"name\":\"xiaomi shouji\", \"desc\":\"erji zhong de huangmenji\", \"price\":2999, \"tags\":[\"low\",\"bufangshui\",\"yinzhicha\"] } PUT /product/_doc/3 { \"name\":\"xiaomi nfc shouji\", \"desc\":\"erji zhong de huangmenji\", \"price\":3999, \"tags\":[\"low\",\"bufangshui\",\"yinzhicha\"] } PUT /product/_doc/4 { \"name\":\"xiaomi yinxiang\", \"desc\":\"erji zhong de huangmenji\", \"price\":4999, \"tags\":[\"low\",\"bufangshui\",\"yinzhicha\"] } GET /product/_doc/_search { \"query\":{ \"match\":{ \"name\":\"shouji xiaomi\" } }, \"sort\":[ {\"price\":\"desc\"}] } POST /product/_doc/1/update { \"doc\":[] } DELETE /product/_doc/1   ES分布式文档系统  实现高可用  ES在分配单个索引的分片时会将每个分片尽可能分配到更多的节点上  但是实际情况取决于集群拥有的分片和索引以及他们的大小,不一定总是能均匀的分布   ES不允许Primary与Replica放在同一个节点中,并且同一个节点不接受完全相同的两个Replica 同一个节点允许多个索引的分片同时存在   容错  向下兼容 自行恢复的能力   ESNode  默认配置 node.master=true node,data=true  Master:主节点,每个集群只有一个 专注于集群的管理 协调节点-转发  尽量避免node.data = true   voting:投票节点  master宕机了投票选举master 数量等于数据节点 设置了Node.voting_only=true 即使node.master=true 也不会参选 voting_only仍然可以做数据节点(node.data=true)   coordinating:协调节点    node.master node.data node.voting_only 节点详情     true 尽量false false master节点 /候选节点,参选为master   false true true 投票节点,不仅投票,还存数据   false false true 不存数据的投票节点 - 协调节点   false true false 数据节点,主要负责数据的查询以及增删改       投票选举master  集群节点数量一般是奇数个 投票节点与与数据节点数量相同  如果是偶数个,默认投票节点减少一个   步骤  寻找clusterStateVersion比自己高的节点,想起发送选票 如果clusterStateVersion一样,则在候选节点(包含当前节点)中选id最小的一个节点,向该节点发送选举投票 如果一个节点收到足够多的投票并且也向自己投票了,那么该节点成为master开始发布集群状态     脑裂问题  discovery.zen.minimum_master_nodes=N/2+1 小于等于两台机子的集群会产生脑裂    ES 查询语法   search\n timeout true/false(默认)  超过指定时间,停止查询,查到多少条返回多少条      Query String\n Url  GET /product/_search?from=0\u0026size=2\u0026sort=price:asc  取前两个 排序  加了排序之后没有相关度分数  因为加了排序之后score就没有意义了 score是null            QueryDSL 重点\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171  GET /product/_search { \"query\": { \"match_all\": {} } } # get GET /product/_search { \"query\": { \"match\": { \"name\": \"nfc\" } } } # sort GET /product/_search { \"query\": { \"match\": { \"name\": \"xiaomi\" } }, \"sort\": [ { \"FIELD\": { \"order\": \"desc\" } } ] } # multi match 多字段查询一个关键词 GET /product/_search { \"query\": { \"multi_match\": { \"query\": \"nfc\", \"fields\": [\"name\",\"desc\"] } }, \"sort\": [ { \"price\": \"asc\" } ] } # _source 指定返回字段 GET /product/_search { \"query\": { \"match\": { \"name\": \"nfc\" } }, \"_source\": [\"name\",\"price\"] } #分页 from size GET /product/_search { \"query\": { \"match_all\": {} }, \"sort\": [ { \"price\": \"asc\" } ], \"from\": 0, \"size\": 1 } # 全文检索 GET /product/_search { \"query\": { \"term\": { \"name\": \"nfc\" } } } # 分词器 GET /_analyze { \"analyzer\":\"standard\", \"text\":\"xiaomi nfc phone\" } #短语搜索 GET /product/_search { \"query\": { \"match_phrase\": { \"name\": \"xiaomi\" } , \"bool\": { } } } #query and filter GET /product/_search { \"query\": { \"bool\": { \"must\": [ {\"match\": {\"name\": \"xiaomi\"}}, {\"match\": {\"desc\" \"shouji\"}}], \"filter\": [ {\"match_phrase\":{\"name\":\"xiaomi\"}}, {\"range\":{\"price\":{ \"gte\":10,\"lte\":20}}} ], \"should\": [ {\"range\": { \"FIELD\": { \"gte\": 10, \"lte\": 20 } }} ], \"minimum_should_match\": 1 } } } # 高亮 GET /product/_search { \"query\": { \"match_phrase\": { \"name\": \"nfc\" } }, \"highlight\": { \"fields\": { \"name\": {} } } } #scroll search GET /product/_search?scroll=1m { \"query\": { \"match_all\": {} }, \"sort\": [ { \"price\": { \"order\": \"desc\" } } ] } GET /_search/scroll { \"scroll_id\" : \"FGluY2x1ZGVfY29udGV4dF91dWlkDXF1ZXJ5QW5kRmV0Y2gBFjhiSmpqSkhqU1FlR1pfbXJYaTZ2ZVEAAAAAAABoRBZJOWhLcFBtUVJfMlg4SU4wQldrV2VR\" }     关键词\n \"term:{}\" query-term完全匹配 不会分词 \"match\":{} 匹配 模糊匹配 先对输入进行分词,对分词后的结果进行查询 \"match_parse\":{} \"match_All\":{} 匹配所有 \"multi_match\":{}:根据多个字段查询一个关键词 \"_source:{}\"元数据,想要查询多个字段  \"from\":0,\"size\":2deep-paging 分页 \"range\":{} \"gte\": NUM \"lte\":NUM 取范围    全文检索  term  不会被分词    短语搜索  match_phrase  Query and filter 查询和过滤  bool   must\n  filter 过滤器,不计算相关度分数,cache\n 缓存功能  filter并不是每次执行都会进行cache,而是当执行一定次数的时候才会进行cache一个二进制数组,1表示匹配,0表示不匹配,这个次数不是固定的 filter会优先过滤掉稀疏的数据,保留匹配的cache数组 filter cache保存的是匹配的结果,不需要再从倒排索引中去查找比对,大大提高查询速度 filter一般会在query之前执行,过滤掉一部分数据,从而提高query速度 filter不计算相关度分数,在执行效率上较query高 党员数据发生改变时,cache也会更新      should 可能满足 or\n 多个条件,满足minimum_should_match 默认是0    must_not 不计算相关度分数\n    Deep paging  深度分页 返回结果不要超过1000个 解决办法  避免深查询 scroll search    scroll search  先查询一部分,给查询的加一个标识,下次继续查询后面的 GET /product/_search?scroll=1m 1m是有效期,1s 1ms  \"scroll\":\"1m\" 延期    Mapping  mapping 就是es数据字段field的type元数据,es在创建索引的时候,dynamic mapping会自动为不同的数据指定相应的mapping mapping中包含了字段的类型,搜索方式(exact value或者full text),分词器等 查看mapping GET /product/_mappings 搜索方式  exact value 精确匹配:在倒排索引过程中,分词器会将field作为一个整体创建到索引中 full text 全文检索,分词,近义词,混淆词,大小写,词性,过滤,时态转换等(normalization)   Mapping Parameter  index 是否对当前字段创建索引,默认为true,如果不创建索引,该字段不会通过索引被搜索到,但仍会在source元数据中展示 analyzer 指定分析器(character filter,tokenizer,Token filters) boost 对当前字段相关度的评分权重,默认是1 coerce 是否允许强制类型转换 copy_to    ",
  "wordCount" : "819",
  "inLanguage": "zh",
  "image":"http://blog.oxide.ink/%3Cimage%20path/url%3E","datePublished": "2021-07-01T20:58:36Z",
  "dateModified": "2021-07-01T20:58:36Z",
  "author":{
    "@type": "Person",
    "name": "Anhlaidh"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "http://blog.oxide.ink/posts/db/elasticsearch/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Oxide",
    "logo": {
      "@type": "ImageObject",
      "url": "http://blog.oxide.ink/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>
<noscript>
    <style type="text/css">
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: #1d1e20;
                --entry: #2e2e33;
                --primary: rgba(255, 255, 255, 0.84);
                --secondary: rgba(255, 255, 255, 0.56);
                --tertiary: rgba(255, 255, 255, 0.16);
                --content: rgba(255, 255, 255, 0.74);
                --hljs-bg: #2e2e33;
                --code-bg: #37383e;
                --border: #333;
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://blog.oxide.ink/" accesskey="h" title="Oxide (Alt + H)">Oxide</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
                <ul class="lang-switch"><li>|</li>
                    <li>
                        <a href="http://blog.oxide.ink/en/" title="English"
                            aria-label="English">English</a>
                    </li>
                </ul>
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="http://blog.oxide.ink/archives" title="文章归档">
                    <span>文章归档</span>
                </a>
            </li>
            <li>
                <a href="http://blog.oxide.ink/categories/" title="分类">
                    <span>分类</span>
                </a>
            </li>
            <li>
                <a href="http://blog.oxide.ink/search/" title="搜索">
                    <span>搜索</span>
                </a>
            </li>
            <li>
                <a href="http://blog.oxide.ink/tags/" title="标签">
                    <span>标签</span>
                </a>
            </li>
            <li>
                <a href="http://blog.oxide.ink/links/" title="友情链接">
                    <span>友情链接</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://blog.oxide.ink/">Home</a>&nbsp;»&nbsp;<a href="http://blog.oxide.ink/posts/">Posts</a></div>
    <h1 class="post-title">
      ElasticSearch
    </h1>
    <div class="post-description">
      DB
    </div>
    <div class="post-meta">July 1, 2021&nbsp;·&nbsp;4 分钟&nbsp;·&nbsp;Anhlaidh&nbsp;|&nbsp;<a href="https://github.com/Anhlaidh/Oxide/blob/master/content/cn/posts/DB/ElasticSearch/index.md" rel="noopener noreferrer" target="_blank">Suggest Changes</a>
</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <div class="details">目录</div>
        </summary>
        <div class="inner"><ul>
                <li>
                    <a href="#%e6%a6%82%e8%bf%b0" aria-label="概述">概述</a></li>
                <li>
                    <a href="#%e6%a0%b8%e5%bf%83%e6%a6%82%e5%bf%b5%e5%92%8c%e5%8e%9f%e7%90%86" aria-label="核心概念和原理">核心概念和原理</a></li>
                <li>
                    <a href="#%e4%bd%bf%e7%94%a8" aria-label="使用">使用</a><ul>
                        
                <li>
                    <a href="#crud" aria-label="CRUD">CRUD</a></li></ul>
                </li>
                <li>
                    <a href="#es%e5%88%86%e5%b8%83%e5%bc%8f%e6%96%87%e6%a1%a3%e7%b3%bb%e7%bb%9f" aria-label="ES分布式文档系统">ES分布式文档系统</a></li>
                <li>
                    <a href="#es-%e6%9f%a5%e8%af%a2%e8%af%ad%e6%b3%95" aria-label="ES 查询语法">ES 查询语法</a><ul>
                        
                <li>
                    <a href="#%e5%85%a8%e6%96%87%e6%a3%80%e7%b4%a2" aria-label="全文检索">全文检索</a></li>
                <li>
                    <a href="#%e7%9f%ad%e8%af%ad%e6%90%9c%e7%b4%a2" aria-label="短语搜索">短语搜索</a></li>
                <li>
                    <a href="#query-and-filter-%e6%9f%a5%e8%af%a2%e5%92%8c%e8%bf%87%e6%bb%a4" aria-label="Query and filter 查询和过滤">Query and filter 查询和过滤</a></li>
                <li>
                    <a href="#deep-paging" aria-label="Deep paging">Deep paging</a><ul>
                        
                <li>
                    <a href="#scroll-search" aria-label="scroll search">scroll search</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#mapping" aria-label="Mapping">Mapping</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h2 id="概述">概述<a hidden class="anchor" aria-hidden="true" href="#概述">#</a></h2>
<ul>
<li>ES不等于搜索引擎</li>
<li>分布式的搜索,存储,数据分析引擎</li>
<li>优点:
<ol>
<li>面向开发者友好,屏蔽了Luncene的复杂特性,集群自动发现</li>
<li>自动维护数据在多个节点上的建立</li>
<li>帮我们做搜索请求的负载均衡</li>
<li>自动维护冗余副本,保证了部分节点宕机的情况下仍然不会有任何数据丢失</li>
<li>ES基于Lucene提供了很多高级功能:符合查询,聚合分析,基于地理位置</li>
<li>对于大公司,可以构建几百台服务器的大型分布式集群,处理PB级别数据</li>
<li>相遇传统数据库,提供了全文见检索,同义词处理,相关度排名,聚合分析以及海量数据的近实时(NTR)处理,这些传统数据库完全做不到</li>
</ol>
</li>
<li>应用领域
<ol>
<li>搜索引擎</li>
<li>各大网站的用户行为日志(点击,浏览,收藏,评论)</li>
<li>BI 数据分析</li>
<li>Github</li>
<li>ELK (Elasticseach(数据存储) Logstash(日志采集) Kibana(可视化))</li>
</ol>
</li>
</ul>
<h2 id="核心概念和原理">核心概念和原理<a hidden class="anchor" aria-hidden="true" href="#核心概念和原理">#</a></h2>
<ul>
<li>搜索
<ul>
<li>SQL 用了%不能用索引 -&gt;性能差
<ul>
<li>like % 搜索时间复杂度O(n)</li>
</ul>
</li>
<li>不能分词</li>
</ul>
</li>
<li>倒排索引
<ol>
<li>分词</li>
<li>生成相关度 *</li>
<li>排序</li>
<li>空间换时间</li>
</ol>
<ul>
<li>数据结构
<ul>
<li>document List</li>
<li>关键词在每个doc中出现的次数 TF term frequency 词频</li>
<li>IDF inverse doc frequency</li>
<li>关键词在当前doc出现的次数</li>
<li>每个doc的长度 越长相关度越低</li>
<li>包含这个关键词的所有doc的平均长度</li>
</ul>
</li>
</ul>
</li>
<li>核心概念
<ul>
<li>集群:每个集群至少包含两个节点</li>
<li>Node:集群中的节点 一个节点不代表是一台机器</li>
<li>Filed: 一个数据字段,与index和type可以定位一个doc</li>
<li>Document:ES最小的数据单元 Json</li>
<li>Type:逻辑上的数据分类</li>
<li>Index:一类相同或者相似的doc</li>
<li>分片shard
<ol>
<li>一个index包含多个shard,默认5p,默认每个p分配一个r,p的数量在创建索引的时候设置,如果想修改,需要重建索引</li>
<li>每个shard都是一个lucene实例,有完整的创建索引的处理请求能力</li>
<li>ES会自动在nodes尚未我们zuoshard均衡</li>
<li>一个doc不可能同时存在于多个PShard,但是可以同时多个Rshard</li>
<li>p和对应的r不能同时存在于同一个节点,所以最低的可用配置是两台节点,互为主备</li>
</ol>
<ul>
<li>横向扩容</li>
<li>Parimary Shared</li>
<li>Replica Shard</li>
</ul>
</li>
</ul>
</li>
<li>容错
<ul>
<li>两台机子p0,p1,p2  r0,r1,r2  p挂掉之后r顶上</li>
<li>容错机制
<ol>
<li>master选举
<ol>
<li>findMaster
<ol>
<li>脑裂  可能会产生多个master节点</li>
</ol>
</li>
<li>判断自己是否为master</li>
<li>广播/findMaster</li>
</ol>
</li>
<li>replica容错</li>
<li>重启故障机</li>
<li>数据恢复
<ul>
<li>只拷贝新增数据 不是全量拷贝</li>
</ul>
</li>
</ol>
</li>
</ul>
</li>
</ul>
<h2 id="使用">使用<a hidden class="anchor" aria-hidden="true" href="#使用">#</a></h2>
<ul>
<li>健康值检查</li>
</ul>
<h3 id="crud">CRUD<a hidden class="anchor" aria-hidden="true" href="#crud">#</a></h3>
<ul>
<li>Query String search  类似于Url挂参数搜索</li>
<li>Query DSL</li>
<li>Query and filter</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">GET /_cat/health?v
PUT /test_index?pretty
GET _cat/indices
DELETE /test_index?pretty

PUT /product/_doc/1
{
    &#34;name&#34;:&#34;xiaomi erji&#34;,
    &#34;desc&#34;:&#34;erji zhong de huangmenji&#34;,
    &#34;price&#34;:1999,
    &#34;tags&#34;:[&#34;low&#34;,&#34;bufangshui&#34;,&#34;yinzhicha&#34;]
}
PUT /product/_doc/2
{
    &#34;name&#34;:&#34;xiaomi shouji&#34;,
    &#34;desc&#34;:&#34;erji zhong de huangmenji&#34;,
    &#34;price&#34;:2999,
    &#34;tags&#34;:[&#34;low&#34;,&#34;bufangshui&#34;,&#34;yinzhicha&#34;]
}
PUT /product/_doc/3
{
    &#34;name&#34;:&#34;xiaomi nfc shouji&#34;,
    &#34;desc&#34;:&#34;erji zhong de huangmenji&#34;,
    &#34;price&#34;:3999,
    &#34;tags&#34;:[&#34;low&#34;,&#34;bufangshui&#34;,&#34;yinzhicha&#34;]
}
PUT /product/_doc/4
{
    &#34;name&#34;:&#34;xiaomi yinxiang&#34;,
    &#34;desc&#34;:&#34;erji zhong de huangmenji&#34;,
    &#34;price&#34;:4999,
    &#34;tags&#34;:[&#34;low&#34;,&#34;bufangshui&#34;,&#34;yinzhicha&#34;]
}


GET /product/_doc/_search
{
  &#34;query&#34;:{
    &#34;match&#34;:{
      &#34;name&#34;:&#34;shouji xiaomi&#34;
    }
  },
    &#34;sort&#34;:[
      {&#34;price&#34;:&#34;desc&#34;}]
    
}
POST /product/_doc/1/update
{
  &#34;doc&#34;:[]
}

DELETE /product/_doc/1
</code></pre></td></tr></table>
</div>
</div><h2 id="es分布式文档系统">ES分布式文档系统<a hidden class="anchor" aria-hidden="true" href="#es分布式文档系统">#</a></h2>
<ol>
<li>实现高可用
<ol>
<li>ES在分配单个索引的分片时会将每个分片尽可能分配到更多的节点上
<ul>
<li>但是实际情况取决于集群拥有的分片和索引以及他们的大小,不一定总是能均匀的分布</li>
</ul>
</li>
<li>ES不允许Primary与Replica放在同一个节点中,并且同一个节点不接受完全相同的两个Replica</li>
<li>同一个节点允许多个索引的分片同时存在</li>
</ol>
</li>
<li>容错
<ol>
<li>向下兼容</li>
<li>自行恢复的能力</li>
</ol>
</li>
<li>ESNode
<ul>
<li>默认配置  node.master=true  node,data=true</li>
</ul>
<ol start="2">
<li>Master:主节点,每个集群只有一个 专注于集群的管理 协调节点-&gt;转发
<ol>
<li>尽量避免node.data = true</li>
</ol>
</li>
<li>voting:投票节点
<ol>
<li>master宕机了投票选举master  数量等于数据节点</li>
<li>设置了Node.voting_only=true 即使node.master=true 也不会参选</li>
<li>voting_only仍然可以做数据节点(node.data=true)</li>
</ol>
</li>
<li>coordinating:协调节点
<table>
<thead>
<tr>
<th>node.master</th>
<th>node.data</th>
<th>node.voting_only</th>
<th>节点详情</th>
</tr>
</thead>
<tbody>
<tr>
<td>true</td>
<td>尽量false</td>
<td>false</td>
<td>master节点 /候选节点,参选为master</td>
</tr>
<tr>
<td>false</td>
<td>true</td>
<td>true</td>
<td>投票节点,不仅投票,还存数据</td>
</tr>
<tr>
<td>false</td>
<td>false</td>
<td>true</td>
<td>不存数据的投票节点   -&gt; 协调节点</td>
</tr>
<tr>
<td>false</td>
<td>true</td>
<td>false</td>
<td>数据节点,主要负责数据的查询以及增删改</td>
</tr>
</tbody>
</table>
</li>
</ol>
</li>
<li>投票选举master
<ol>
<li>集群节点数量一般是奇数个  投票节点与与数据节点数量相同
<ol>
<li>如果是偶数个,默认投票节点减少一个</li>
</ol>
</li>
<li>步骤
<ol>
<li>寻找clusterStateVersion比自己高的节点,想起发送选票</li>
<li>如果clusterStateVersion一样,则在候选节点(包含当前节点)中选id最小的一个节点,向该节点发送选举投票</li>
<li>如果一个节点收到足够多的投票并且也向自己投票了,那么该节点成为master开始发布集群状态</li>
</ol>
</li>
</ol>
</li>
<li>脑裂问题
<ol>
<li>discovery.zen.minimum_master_nodes=N/2+1</li>
<li>小于等于两台机子的集群会产生脑裂</li>
</ol>
</li>
</ol>
<h2 id="es-查询语法">ES 查询语法<a hidden class="anchor" aria-hidden="true" href="#es-查询语法">#</a></h2>
<ul>
<li>
<p>search</p>
<ul>
<li>timeout true/false(默认)
<ul>
<li>超过指定时间,停止查询,查到多少条返回多少条</li>
</ul>
</li>
</ul>
</li>
<li>
<p>Query String</p>
<ul>
<li>Url
<ul>
<li><code>GET /product/_search?from=0&amp;size=2&amp;sort=price:asc</code>
<ul>
<li>取前两个 排序
<ul>
<li>加了排序之后没有相关度分数
<ul>
<li>因为加了排序之后score就没有意义了  score是null</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p>QueryDSL  重点</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">  GET /product/_search
  {
    &#34;query&#34;: {
      &#34;match_all&#34;: {}
    }
  }
  # get
  GET /product/_search
  {
    &#34;query&#34;: {
      &#34;match&#34;: {
        &#34;name&#34;: &#34;nfc&#34;
      }
    }
  }

  # sort
  GET /product/_search
  {
    &#34;query&#34;: {
      &#34;match&#34;: {
        &#34;name&#34;: &#34;xiaomi&#34;
      }
    },
    &#34;sort&#34;: [
      {
        &#34;FIELD&#34;: {
          &#34;order&#34;: &#34;desc&#34;
        }
      }
    ]
  }
  # multi match 多字段查询一个关键词
  GET /product/_search
  {
    &#34;query&#34;: {
      &#34;multi_match&#34;: {
        &#34;query&#34;: &#34;nfc&#34;,
        &#34;fields&#34;: [&#34;name&#34;,&#34;desc&#34;]
      }
    },
    &#34;sort&#34;: [
      {
        &#34;price&#34;: &#34;asc&#34;
      }
    ]
  }

  # _source 指定返回字段

  GET /product/_search
  {
    &#34;query&#34;: {
      &#34;match&#34;: {
        &#34;name&#34;: &#34;nfc&#34;
      }
    },
    &#34;_source&#34;: [&#34;name&#34;,&#34;price&#34;]
  }


  #分页 from size
  GET /product/_search
  {
    &#34;query&#34;: {
      &#34;match_all&#34;: {}
    },
    &#34;sort&#34;: [
      {
          &#34;price&#34;: &#34;asc&#34;
      }
    ], 
    &#34;from&#34;: 0,
    &#34;size&#34;: 1
  }

# 全文检索
GET /product/_search
{
  &#34;query&#34;: {
    &#34;term&#34;: {
        &#34;name&#34;: &#34;nfc&#34;

    }
  }
}

# 分词器
GET /_analyze
{
  &#34;analyzer&#34;:&#34;standard&#34;,
  &#34;text&#34;:&#34;xiaomi nfc phone&#34;
}

#短语搜索
GET /product/_search
{
  &#34;query&#34;: {
    &#34;match_phrase&#34;: {
      &#34;name&#34;: &#34;xiaomi&#34;
    }
    , &#34;bool&#34;: {

    }
  }
}


#query and filter
GET /product/_search
{
  &#34;query&#34;: {
    &#34;bool&#34;: {
      &#34;must&#34;: [
        {&#34;match&#34;: {&#34;name&#34;: &#34;xiaomi&#34;}},
        {&#34;match&#34;: {&#34;desc&#34;  &#34;shouji&#34;}}],
        &#34;filter&#34;: [
          {&#34;match_phrase&#34;:{&#34;name&#34;:&#34;xiaomi&#34;}},
          {&#34;range&#34;:{&#34;price&#34;:{ &#34;gte&#34;:10,&#34;lte&#34;:20}}}
        ],
        &#34;should&#34;: [
          {&#34;range&#34;: {
            &#34;FIELD&#34;: {
              &#34;gte&#34;: 10,
              &#34;lte&#34;: 20
            }
          }}
        ],
        &#34;minimum_should_match&#34;: 1

    }
  }
}


# 高亮
GET /product/_search
{
   &#34;query&#34;: {
     &#34;match_phrase&#34;: {
       &#34;name&#34;: &#34;nfc&#34;
     }
   },
   &#34;highlight&#34;: {
     &#34;fields&#34;: {
       &#34;name&#34;: {}
     }
   }
}

#scroll search 
GET /product/_search?scroll=1m
{
  &#34;query&#34;: {
    &#34;match_all&#34;: {}
  },
  &#34;sort&#34;: [
    {
      &#34;price&#34;: {
        &#34;order&#34;: &#34;desc&#34;
      }
    }
  ]
}

GET /_search/scroll
{
  &#34;scroll_id&#34; : &#34;FGluY2x1ZGVfY29udGV4dF91dWlkDXF1ZXJ5QW5kRmV0Y2gBFjhiSmpqSkhqU1FlR1pfbXJYaTZ2ZVEAAAAAAABoRBZJOWhLcFBtUVJfMlg4SU4wQldrV2VR&#34;
}


</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>关键词</p>
<ul>
<li><code>&quot;term:{}&quot;</code> query-term完全匹配 不会分词</li>
<li><code>&quot;match&quot;:{}</code> 匹配 模糊匹配 先对输入进行分词,对分词后的结果进行查询</li>
<li><code>&quot;match_parse&quot;:{}</code></li>
<li><code>&quot;match_All&quot;:{}</code> 匹配所有</li>
<li><code>&quot;multi_match&quot;:{}</code>:根据多个字段查询一个关键词</li>
<li><code>&quot;_source:{}&quot;元数据,想要查询多个字段</code></li>
<li><code> &quot;from&quot;:0,&quot;size&quot;:2</code>deep-paging 分页</li>
<li><code>&quot;range&quot;:{}</code> <code>&quot;gte&quot;: NUM</code> <code>&quot;lte&quot;:NUM</code> 取范围</li>
</ul>
</li>
</ul>
<h3 id="全文检索">全文检索<a hidden class="anchor" aria-hidden="true" href="#全文检索">#</a></h3>
<ul>
<li>term
<ul>
<li>不会被分词</li>
</ul>
</li>
</ul>
<h3 id="短语搜索">短语搜索<a hidden class="anchor" aria-hidden="true" href="#短语搜索">#</a></h3>
<ul>
<li>match_phrase</li>
</ul>
<h3 id="query-and-filter-查询和过滤">Query and filter 查询和过滤<a hidden class="anchor" aria-hidden="true" href="#query-and-filter-查询和过滤">#</a></h3>
<ul>
<li>bool
<ul>
<li>
<p>must</p>
</li>
<li>
<p>filter 过滤器,不计算相关度分数,cache</p>
<ul>
<li>缓存功能
<ol>
<li>filter并不是每次执行都会进行cache,而是当执行一定次数的时候才会进行cache一个二进制数组,1表示匹配,0表示不匹配,这个次数不是固定的</li>
<li>filter会优先过滤掉稀疏的数据,保留匹配的cache数组</li>
<li>filter cache保存的是匹配的结果,不需要再从倒排索引中去查找比对,大大提高查询速度</li>
<li>filter一般会在query之前执行,过滤掉一部分数据,从而提高query速度</li>
<li>filter不计算相关度分数,在执行效率上较query高</li>
<li>党员数据发生改变时,cache也会更新</li>
</ol>
</li>
</ul>
</li>
<li>
<p>should 可能满足  or</p>
<ul>
<li>多个条件,满足minimum_should_match 默认是0</li>
</ul>
</li>
<li>
<p>must_not 不计算相关度分数</p>
</li>
</ul>
</li>
</ul>
<h3 id="deep-paging">Deep paging<a hidden class="anchor" aria-hidden="true" href="#deep-paging">#</a></h3>
<ol>
<li>深度分页</li>
<li>返回结果不要超过1000个</li>
<li>解决办法
<ul>
<li>避免深查询</li>
<li>scroll search</li>
</ul>
</li>
</ol>
<h4 id="scroll-search">scroll search<a hidden class="anchor" aria-hidden="true" href="#scroll-search">#</a></h4>
<ul>
<li>先查询一部分,给查询的加一个标识,下次继续查询后面的
GET /product/_search?scroll=1m  1m是有效期,1s 1ms
<ul>
<li><code>&quot;scroll&quot;:&quot;1m&quot;</code> 延期</li>
</ul>
</li>
</ul>
<h2 id="mapping">Mapping<a hidden class="anchor" aria-hidden="true" href="#mapping">#</a></h2>
<ul>
<li>mapping 就是es数据字段field的type元数据,es在创建索引的时候,dynamic mapping会自动为不同的数据指定相应的mapping
mapping中包含了字段的类型,搜索方式(exact value或者full text),分词器等</li>
<li>查看mapping <code>GET /product/_mappings</code></li>
<li>搜索方式
<ol>
<li>exact value 精确匹配:在倒排索引过程中,分词器会将field作为一个整体创建到索引中</li>
<li>full text 全文检索,分词,近义词,混淆词,大小写,词性,过滤,时态转换等(normalization)</li>
</ol>
</li>
<li>Mapping Parameter
<ol>
<li>index 是否对当前字段创建索引,默认为true,如果不创建索引,该字段不会通过索引被搜索到,但仍会在source元数据中展示</li>
<li>analyzer 指定分析器(character filter,tokenizer,Token filters)</li>
<li>boost 对当前字段相关度的评分权重,默认是1</li>
<li>coerce 是否允许强制类型转换</li>
<li>copy_to</li>
</ol>
</li>
</ul>

</div>


  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://blog.oxide.ink/tags/db/">DB</a></li>
    </ul>
<nav class="paginav">
  <a class="next" href="http://blog.oxide.ink/posts/java/java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/">
    <span class="title">下一页 »</span>
    <br>
    <span>Java并发编程</span>
  </a>
</nav>


  </footer><section class="comments">

    <script src="https://utteranc.es/client.js"
            repo="Anhlaidh/Oxside"
            issue-term="pathname"
            theme="preferred-color-scheme"
            crossorigin="anonymous"
            async>
    </script>

</section>

</article>
    </main>
    <footer class="footer">
    <span>&copy; 2021 <a href="http://blog.oxide.ink/">Oxide</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://git.io/hugopapermod" rel="noopener" target="_blank">PaperMod</a>
    </span>
    <br>
    <span>Anhlaidh
        <a href="#">chinahantianzhao@foxmail.com</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)">
    <button class="top-link" id="top-link" type="button" accesskey="g">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
            <path d="M12 6H0l6-6z" />
        </svg>
    </button>
</a><script src="https://cdn.bootcss.com/mermaid/8.0.0-rc.8/mermaid.min.js"></script>
<script>
    let parm1 = ''
    if (document.cookie.indexOf("uv=false") == -1) {
        parm1 = "&uv=true"
        var t = new Date(new Date().getTime() + 1000 * 60 * 60 * 24);
        document.cookie = "uv=false; expires=" + t.toGMTString() + ";path=/";
    }
    fetch("https://analytics.radishkin.workers.dev/api?url=" + window.btoa(location.href) + parm1).then(res => {
        return res.json()
    }).then(res => {
        try {
            document.getElementById("busuanzi_value_page_pv").innerText = res.pv
        } catch(err) {}
        try{
            document.getElementById("busuanzi_container_site_uv").innerText = res.uv
        }catch(err){}
        try{
            document.getElementById("busuanzi_container_site_pv").innerText = res.total
        }catch(err){}
    })

</script>

<script>
    let menu = document.getElementById('menu')
    menu.scrollLeft = localStorage.getItem("menu-scroll-position");
    menu.onscroll = function () {
        localStorage.setItem("menu-scroll-position", menu.scrollLeft);
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;
        var isHide = true;

        const copybutton = document.createElement('button');
        const showbutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        showbutton.classList.add('show-code-button');
        copybutton.innerText = 'copy';
        showbutton.innerText = 'show';

        function copyingDone() {
            copybutton.innerText = 'copied!';
            setTimeout(() => {
                copybutton.innerText = 'copy';
            }, 2000);
        }
        showbutton.addEventListener('click',()=>{
            if (isHide === true) {
                
                showbutton.parentElement.classList.add("code-showing")
                showbutton.innerText = 'hide';
                isHide = false;
            } else {
                
                showbutton.parentElement.classList.remove("code-showing")
                showbutton.innerText = 'show';
                isHide = true;
            }

        })

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
            container.appendChild(showbutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(showbutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
            codeblock.parentNode.appendChild(showbutton);
        }
    });
</script>
</body>

</html>
